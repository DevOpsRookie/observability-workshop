



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://signalfx.github.io/app-dev-workshop/archive/apm-python/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Apm python - App Dev Workshop</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="black" data-md-color-accent="pink">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#step-1-infrastructure-setup-complete-now-lets-run-our-first-fully-monitored-application" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://signalfx.github.io/app-dev-workshop/" title="App Dev Workshop" aria-label="App Dev Workshop" class="md-header-nav__button md-logo">
          
            <img alt="logo" src="../../images/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              App Dev Workshop
            </span>
            <span class="md-header-nav__topic">
              
                Apm python
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/signalfx/app-dev-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://signalfx.github.io/app-dev-workshop/" title="App Dev Workshop" class="md-nav__button md-logo">
      
        <img alt="logo" src="../../images/logo.png" width="48" height="48">
      
    </a>
    App Dev Workshop
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/signalfx/app-dev-workshop/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Module One
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Module One
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../module1/dashboards/" title="1. Working with Dashboards, Charts and Metrics" class="md-nav__link">
      1. Working with Dashboards, Charts and Metrics
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../module1/detectors/" title="2. Working with Detectors" class="md-nav__link">
      2. Working with Detectors
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../module1/muting/" title="3. Working with Muting Rules" class="md-nav__link">
      3. Working with Muting Rules
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../module1/k3s/" title="4. Running the Smart Agent in Kubernetes (K3s)" class="md-nav__link">
      4. Running the Smart Agent in Kubernetes (K3s)
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../module1/nginx/" title="5. Deploying NGINX in K3s" class="md-nav__link">
      5. Deploying NGINX in K3s
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../module1/terraform/" title="6. Monitoring as Code with Detectors & Dashboards" class="md-nav__link">
      6. Monitoring as Code with Detectors & Dashboards
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../module1/service_bureau/" title="7. Service Bureau" class="md-nav__link">
      7. Service Bureau
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Module Two
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Module Two
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../module2/hotrod/" title="1. µAPM: Hotrod in K3s" class="md-nav__link">
      1. µAPM: Hotrod in K3s
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../module2/sockshop/" title="2. µAPM: Sock Shop in K3s" class="md-nav__link">
      2. µAPM: Sock Shop in K3s
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../cleanup/" title="Cleaning Up!" class="md-nav__link">
      Cleaning Up!
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#step-1-infrastructure-setup-complete-now-lets-run-our-first-fully-monitored-application" class="md-nav__link">
    Step 1: Infrastructure setup complete, now let’s run our first fully monitored application!
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-2-generate-some-traces" class="md-nav__link">
    Step 2: Generate some Traces
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-3-visualizing-the-data" class="md-nav__link">
    Step 3: Visualizing the Data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#step-4-analyzing-traces" class="md-nav__link">
    Step 4: Analyzing Traces
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/signalfx/app-dev-workshop/edit/master/docs/modules/archive/apm-python.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Apm python</h1>
                
                <h2 id="step-1-infrastructure-setup-complete-now-lets-run-our-first-fully-monitored-application">Step 1: Infrastructure setup complete, now let’s run our first fully monitored application!<a class="headerlink" href="#step-1-infrastructure-setup-complete-now-lets-run-our-first-fully-monitored-application" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Switch to the Application instance (the one created in Lab #1) and change to the mypythonapp directory
   <div class="codehilite"><pre><span></span><code><span class="nb">cd</span> ~/mypythonapp
</code></pre></div></p>
</li>
<li>
<p>In order to see how the demonstration Python application has been instrumented using https://github.com/signalfx/signalfx-python-tracing type <code>more demo.py</code>
   <div class="codehilite"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">signalfx_tracing</span> <span class="kn">import</span> <span class="n">trace</span>
<span class="kn">import</span> <span class="nn">opentracing</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@trace</span>
<span class="k">def</span> <span class="nf">convert_response</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
  <span class="c1"># In this example we want to force this trace to be retained</span>
  <span class="n">opentracing</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">active_span</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;sampling.priority&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">opentracing</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">active_span</span><span class="o">.</span><span class="n">set_tag</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>
  <span class="nb">print</span><span class="p">(</span><span class="n">opentracing</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">active_span</span><span class="p">)</span>
  <span class="k">return</span> <span class="s1">&#39;You said: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/echo&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">echo</span><span class="p">():</span>
  <span class="n">message</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="n">convert_response</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre></div></p>
</li>
<li>
<p>Start the Python application by running the following command, replace <code>[YOUR_INITIALS]</code> to make your application unique.
   <div class="codehilite"><pre><span></span><code><span class="nv">SIGNALFX_SERVICE_NAME</span><span class="o">=[</span>YOUR_INITIALS<span class="o">]</span>-app-dev-python-app sfx-py-trace ./demo.py <span class="p">&amp;</span> <span class="nb">disown</span>
</code></pre></div></p>
</li>
</ol>
<p><strong>IMPORTANT:</strong> After running this code, hit the enter key in your keyboard to get out of the process and continue with the following steps. Don't worry, your python app will continue running in the background.</p>
<hr />
<h2 id="step-2-generate-some-traces">Step 2: Generate some Traces<a class="headerlink" href="#step-2-generate-some-traces" title="Permanent link">&para;</a></h2>
<ol>
<li>We will be using a really practical tool to simulate requests called Apache Benchmark or ab. But first let's make sure that the service we started before can actually accept requests, by running the following command:
   <div class="codehilite"><pre><span></span><code>curl -XPOST -d<span class="s1">&#39;Hello, world&#39;</span> -H<span class="s1">&#39;Content-Type:text/plain&#39;</span> http://localhost:5000/echo
</code></pre></div></li>
</ol>
<p>You should get something like:
   <div class="codehilite"><pre><span></span><code>795cf220f0ee0afa:7a1f10140ad14024:4a81cc4098335da:3 rwc-app-dev-python-app.convert_response
<span class="m">127</span>.0.0.1 - - <span class="o">[</span><span class="m">04</span>/Nov/2019 <span class="m">15</span>:07:24<span class="o">]</span> <span class="s2">&quot;POST /echo HTTP/1.1&quot;</span> <span class="m">200</span> -
</code></pre></div></p>
<p>If you don't get this response, make sure the Step #1.2 (above) was executed properly and that you have a service running called <code>./demo.py</code> executed by python. On the Application instance itself you can confirm this by running <code>ps -ef | grep demo.py</code></p>
<ol>
<li>
<p>Now that we know we can call our service, let's run ab to simulate load and start generating traces that our Smart Gateway can capture and send to the SignalFx platform. Confirm a file named <code>~/mypythonapp/post_data.json</code> exists and has the following inside:
   <div class="codehilite"><pre><span></span><code>&quot;Hello from the App Dev Workshop!&quot;
</code></pre></div></p>
</li>
<li>
<p>Save the file, and in the same directory, execute the following:
   <div class="codehilite"><pre><span></span><code>ab -p post_data.json -T application/json -c20 -n1000 http://localhost:5000/echo
</code></pre></div></p>
</li>
</ol>
<p>This will create 20 concurrent connections to our localhost python app, and it will post the data 1000 times.</p>
<hr />
<h2 id="step-3-visualizing-the-data">Step 3: Visualizing the Data<a class="headerlink" href="#step-3-visualizing-the-data" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Over in SignalFx, under the Built-In Dashboard Groups, you will see a Smart Gateway Dashboard group. Go to the Cluster(s) Dashboard:</p>
</li>
<li>
<p>Over there you will see information about the host running the Smart Gateway, and a few other numbers that are important. But the most important of all, are the 3 big number group of charts, showing TAPM, Retained TPM and APM Identities.</p>
</li>
<li>
<p><strong>TAPM</strong> are the Traces Analysed Per Minute, which is the amount of traces that the Smart Gateway is ingesting and processing.</p>
</li>
<li>
<p><strong>Retained TPM</strong> are the traces that the Smart Gateway, after processing them, think are important to keep, and send to SignalFx for further analysis by the users.</p>
</li>
<li>
<p><strong>APM Identities</strong> are each unique span and initiating span/endpoint tracked by the Smart Gateway and sent to SignalFx. To explain this a little better please see the following image:</p>
</li>
</ol>
<p>If you want to know more about Traces, Spans, Metrics and Metadata, please follow this link. If everything goes according to plan, you should see in that dashboard, some numbers that represent the test we just did.</p>
<hr />
<h2 id="step-4-analyzing-traces">Step 4: Analyzing Traces<a class="headerlink" href="#step-4-analyzing-traces" title="Permanent link">&para;</a></h2>
<ol>
<li>
<p>Navigate to uAPM → Traces on the main toolbar, then ensure you have selected your cluster from the Cluster dropdown at the top left, you should see something like this:</p>
</li>
<li>
<p>Feel free to investigate our built-in Outlier Analysis, showing the potential source of our problems in our application, or navigate to some of the traces, and inspect the payload we sent in our test.
You go to a trace by clicking on it:</p>
</li>
</ol>
<p>Then click on the span that handled the response, and see the message:</p>
<ol>
<li>
<p>Feel free to continue navigating uAPM features now that we have traces and spans going in.
Also, you can try sending more tests or changing the payload of the tests to see how fast the new tests are ingested and analyzed in SignalFx.</p>
</li>
<li>
<p>Once you finish, please proceed to <a href="https://github.com/signalfx/app-dev-workshop/wiki/Module-2-Lab-3:-Simple-Java-auto-instrumentation">Lab 3: Simple Java auto-instrumentation</a></p>
</li>
</ol>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:"../.."}})</script>
      
    
  </body>
</html>