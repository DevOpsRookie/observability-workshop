#cloud-config
ssh_pwauth: yes
password: AppDev2020!
chpasswd:
  expire: false

package_update: true

apt:
  sources_list: | 
    deb mirror://mirrors.ubuntu.com/mirrors.txt bionic main restricted universe multiverse
    deb mirror://mirrors.ubuntu.com/mirrors.txt bionic-updates main restricted universe multiverse
    deb mirror://mirrors.ubuntu.com/mirrors.txt bionic-backports main restricted universe multiverse
    deb mirror://mirrors.ubuntu.com/mirrors.txt bionic-security main restricted universe multiverse

packages:
 - apache2-utils
 - unzip

write_files:
 - path: /etc/environment
   permissions: 0644
   content: | 
     KUBECONFIG="/etc/rancher/k3s/k3s.yaml"
   append: true
 - path: /etc/skel/.profile
   content: | 
     helm() {
       if [ -z ${ACCESS_TOKEN+x} ]; then echo "ACCESS_TOKEN is unset. Please export ACCESS_TOKEN=YOURTOKEN"; return; fi
       if [ -z ${REALM+x} ]; then echo "REALM is unset. Please export REALM=YOURREALM"; return; fi
       if [ -z ${VERSION+x} ]; then echo "VERSION is unset. Please export VERSION=5.1.6"; return; fi
     command helm "$@"
     }
   append: true

runcmd:
 - 'curl -sfL https://get.k3s.io | K3S_KUBECONFIG_MODE="644" INSTALL_K3S_EXEC="server" sh -s -'
 - chmod 644 /etc/rancher/k3s/k3s.yaml
 - export WSVERSION=1.14
 - curl -s -OL https://github.com/signalfx/app-dev-workshop/archive/v$WSVERSION.zip
 - unzip -qq v$WSVERSION.zip -d /home/ubuntu/
 - mv /home/ubuntu/app-dev-workshop-$WSVERSION /home/ubuntu/workshop
 - 'sed -i -e ''s/\[HOSTNAME\]/''"$(hostname)"''/'' /home/ubuntu/workshop/k3s/values.yaml'
 - curl -s -L https://github.com/signalfx/signalfx-jumpstart/archive/master.zip -o jumpstart.zip
 - unzip -qq jumpstart.zip -d /home/ubuntu/
 - mv /home/ubuntu/signalfx-jumpstart-master /home/ubuntu/signalfx-jumpstart
 - curl -s https://raw.githubusercontent.com/signalfx/app-dev-workshop/master/etc/motd -o /etc/motd
 - 'curl -s https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 | bash'
 - curl -s -OL https://github.com/derailed/k9s/releases/download/v0.19.3/k9s_Linux_x86_64.tar.gz
 - tar xfz k9s_Linux_x86_64.tar.gz
 - mv k9s /usr/local/bin/
 - chmod -x /etc/update-motd.d/*
 - 'curl -s https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o awscliv2.zip'
 - unzip -qq awscliv2.zip
 - ./aws/install
 - 'curl -s --silent --location https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz | tar xz -C /tmp'
 - mv /tmp/eksctl /usr/local/bin/
 - curl -s -OL https://releases.hashicorp.com/terraform/0.12.24/terraform_0.12.24_linux_amd64.zip
 - unzip -qq terraform_0.12.24_linux_amd64.zip
 - mv terraform /usr/local/bin/
 - chown -R ubuntu:ubuntu /home/ubuntu
